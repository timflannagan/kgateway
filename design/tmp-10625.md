# EP-10625: Invalid Route Replacement

* Issue: [#10625](https://github.com/kgateway-dev/kgateway/issues/10625)

## Background

Currently, when a user adds an invalid route - for example, a route to an upstream which does not currently exist - we ellide that route from the configuration sent to Envoy. In many scenarios, this results in users making requests that would otherwise match that route, to instead receive a "No Healthy Upstream" message along with a HTTP 404.

There are scenarios where this behavior however is undesirable or insufficient.

### Scenario 1: Misrouted requests.

If we configure Route 1 with a prefix match for requests to `/path/bad` and Route 2 with a prefix match for requests to `/path`, and we misconfigure Route 1, then requests will be erroneously routed to Route 2. This can cause undesirable consequences, such as requests being reported as healthy 200's and hiding the error from metrics, or users being routed to the wrong service entirely.

### Scenario 2: Accidental exposure of secure routes without associated security policies configured.

In this scenario we configure a Route to `/userInfo` which relies on authentication, attached via a `RoutePolicy` for example. If there is a problem with that auth policy which might result in it not attaching - such as a bad configuration, missing ExtAuth server etc - we need to make sure that the original Route does NOT propagate to the gateway. Put another way, failure of an attached security policy to a route should _also_ result in that Route being removed from that gateway, as it the route itself was misconfigured.

## Motivation

The previous 1.x implementation provided two key guardrails that prevented invalid configuration from being propagated to the data plane:

- Validating admission webhook: Prevent invalid configuration from being persisted to etcd
- Route Replacement: When translation succeeded initially but later evolved into an invalid state, the controller attempted to replace the affected route with a direct response route, while preserving traffic for unaffected routes.

For the latter, invalid route replacement is crucial to prevent the following high-level scenarios:

- A security policy is misconfigured, leading to insecure routes being exposed without security applied
- Invalid routing

Those guardrails proved valuable, yet highlighted several scenarios where we could improve the user experience. Webhook outages blocked all writes, had order of operations issues, and the logic was bound to the legacy 1.x APIs and their routing model that the Gateway API supersedes.

This proposal is focused on re‑implementing the guardrails for the 2.x project, embracing Gateway API and our new delegation model, while maintaining the same high‑level guarantees: limit the impact of invalid configuration for multi-tenant environments, and provide precise feedback to the user.

Implementing invalid route replacement is crucial for:

- Multi-tenancy in an environment with a shared gateway
- Ensuring no secure routes are accidentally exposed without security applied
- Making Route updates atomic - no route updates should be able to affect any other route.
- Guaranteeing that an invalid route configuration does not result in unwanted traffic to another route

### Goals

1. Implement invalid route replacement, for the following scenarios:
  a. Configured target destination does not exist
  b. Security policy applied to route is in an invalid/unaccepted state

### Non-Goals

- Preventing all possible misconfigurations at admission time

## Kubernetes Gateway API Spec

The [Kubernetes Gateway API Spec](https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteStatus) has guidance on how to handle invalid routes:

> Invalid Route rules can be ignored (sometimes that will mean the full Route). If a Route rule transitions from valid to invalid, support for that Route rule should be dropped to ensure consistency. For example, even if a filter specified by a Route rule is invalid, the rest of the rules within that Route should still be supported.

The proposal outlined in this document would still be compliant with "invalid rules can be ignored", as we're not actually building the original routing rule, but rather adding our own placeholder which has the effect of rejecting the route.

Also relevant:
> When no rules matching a request have been successfully attached to the parent a request is coming from, a HTTP 404 status code MUST be returned.

Depending on the interpretation of this, it may mean that we can't allow the user to configure the HTTP response code.

## Implementation Details

### Configuration

The following settings need to be user-configurable:
TODO: Confirm these default values.
TODO: Confirm where exactly this config should live in helm chart.
- Invalid response body - The body returned to the end user hitting an invalid route/
  - Default: "KGateway has invalid configuration. Administrators should check the HTTPRoute resource to find and fix config errors."
- Invalid response code - The HTTP code returned to the end user hitting an invalid route
  - Default: 404
  - TODO: Making this code configurable may break compliance with the current k8s gateway API Spec (See "K8s Gateway API Spec" section above)
- Enable/Disable feature
  - Default Enabled

This configuration will live in the helm chart
  - TODO: Decide if this should be passed through to env variables or CLI args in control plane container?

### Control plane

When handling the translation logic for HTTPRoutes, any configuration which would make the route invalid - previously resulting in the route being ellided from the resulting configuration sent to Envoy - will instead result in a direct response route being configured, with the settings above.

Examples of things that could result in the route being invalid:

- Missing destination for route target
- TODO: Add more here

Separately, when translating security policies attached to a route, if the security policy configuration results in an invalid/rejected state, if it's still got a valid route attachment, that attached route should be replaced by the direct response route.

Specifically, security policies include:

- ExtAuth
- JWT
- TODO: Add more here
- Transformations?

### Controllers

No new controllers required. Existing controllers will:

- Watch for changes to HTTPRoutes and any attached policies

### Monitoring & Telemetry

#### Metrics

When an invalid route is replaced, we should increment a metric (Gauge) so that this can be piped into a monitoring dashboard.
TODO: Should we have CR-level labels on this metric, or does that result in problems with high cardinality? Would help identify problematic resources easily, if it's feasible.

#### Logs

When an invalid route is replaced, it should be logged.
TODO: Confirm we're OK with this, could end up being verbose in larger environments. General problem with translation errors, particularly if we consider this a 'warning'.

### Test Plan

1. Unit Tests:
   - Test for each scenario outlined above in "Control Plane" section
   - Test that changing helm configuration for invalidRouteReplacement changes response results

2. Integration Tests:
   - Confirm that no other routes erroneously receive traffic after a sibling route is replaced

3. E2E Tests:
   - Test that:
     1. A functional route works
     2. Change, in two separate tests:
       a. Security policy to be invalid
       b. Route destination to be invalid
     3. In both scenarios, test that we receive a direct response on subsequent requests
     4. Test that fixing the misconfiguration(s) result in original route functionality restored

## Alternatives

1. Elide invalid routes
  - This is the current approach.
  - Does not work because it can result in traffic sent to the wrong route, which could hide real errors or overwhelm other services.

2. Reject invalid routes at admission time:
   - This is the ideal scenario, but is not always feasible, particularly when validation involves multiple resources. For example, we need to allow late binding, which is a valid use case.

## Open Questions

- [ ] Decide where in helm chart the invalidRouteReplacement settings should live.
- [ ] Confirm default values for invalidRouteReplacement settings.
- [ ] Finalize list of policies which should trigger invalidRouteReplacement when invalid.
- [ ] Finalize list of error scenarios at route level which should trigger invalidRouteReplacement.
- [ ] Decide if a route in this state should be considered a Warning or an Error.
- [ ] Some open questions about telemetry & Metrics - see Monitoring & Telemetry section.
- [ ] Confirm if HTTP response code should be customizable or hard coded to 404.
